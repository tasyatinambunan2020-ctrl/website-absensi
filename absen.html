<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Absensi PKL Mahasiswa - PLN ULP Medan Baru</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #007bff, #00bcd4);
      font-family: 'Poppins', sans-serif;
      color: #333;
    }
    .container { max-width: 600px; margin-top: 40px; }
    .card {
      border: none;
      border-radius: 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      background: #fff;
    }
    .btn { border-radius: 12px; font-weight: 500; }
    video, canvas {
      width: 100%;
      border-radius: 15px;
      border: 2px solid #e0e0e0;
    }
    h4 { color: #007bff; font-weight: 600; }
    .footer {
      text-align: center;
      margin-top: 25px;
      color: white;
      font-size: 14px;
    }
    .radius-info { font-size: 14px; margin-top: 5px; }
  </style>
</head>
<body>

<div class="container">
  <div class="card p-4">
    <h4 class="text-center mb-3">üìã Absensi PKL Mahasiswa<br>PLN ULP Medan Baru</h4>

    <div class="row g-2">
      <div class="col-md-6">
        <label class="form-label">NIRM</label>
        <input type="text" id="nirm" class="form-control" placeholder="Masukkan NIRM">
      </div>
      <div class="col-md-6">
        <label class="form-label">Nama Lengkap</label>
        <input type="text" id="nama" class="form-control" placeholder="Masukkan nama">
      </div>
      <div class="col-md-12">
        <label class="form-label">Jurusan / Prodi</label>
        <input type="text" id="jurusan" class="form-control" placeholder="Contoh: Sistem Informasi">
      </div>
    </div>

    <div class="mt-3">
      <video id="video" autoplay></video>
      <canvas id="canvas" style="display:none;"></canvas>
      <button class="btn btn-outline-primary w-100 mt-2" id="ambilFoto">üì∏ Ambil Foto</button>
    </div>

    <div class="mt-3">
      <label class="form-label">üìç Lokasi Anda</label>
      <input id="lokasi" class="form-control" readonly>
      <div id="lokasiStatus" class="radius-info"></div>
    </div>

    <div class="d-grid gap-2 mt-3">
      <button class="btn btn-primary" id="kirimAbsensi">‚úÖ Kirim Absensi</button>
      <button class="btn btn-outline-secondary" id="resetForm">‚Ü© Reset</button>
    </div>
  </div>

  <div class="card p-4 mt-4">
    <h5>üßæ Data Absensi</h5>
    <div class="d-grid gap-2 mt-2">
      <button class="btn btn-success" id="exportCSV">üìÑ Export CSV</button>
      <button class="btn btn-info text-white" id="cetakDaftar">üñ® Cetak</button>
      <button class="btn btn-danger" id="hapusData">üóë Hapus Semua</button>
    </div>
  </div>

  <div class="footer">¬© 2025 PLN ULP Medan Baru | Sistem Absensi PKL</div>
</div>

<script>
// ========== KAMERA ==========
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ambilFotoBtn = document.getElementById('ambilFoto');
let fotoData = "";

navigator.mediaDevices.getUserMedia({ video: true })
  .then(stream => video.srcObject = stream)
  .catch(err => alert("Kamera tidak dapat diakses: " + err));

ambilFotoBtn.addEventListener('click', () => {
  const ctx = canvas.getContext('2d');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video, 0, 0);
  fotoData = canvas.toDataURL('image/png');
  video.style.display = 'none';
  canvas.style.display = 'block';
});

// ========== GPS & RADIUS PLN ==========
const lokasiInput = document.getElementById('lokasi');
const lokasiStatus = document.getElementById('lokasiStatus');

// üìç Titik PLN ULP Medan Baru
const PLN_LAT = 3.574240;
const PLN_LNG = 98.657068;
const RADIUS_BATAS = 0.6; // 600 meter

function hitungJarak(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

function cekRadius(lat, lon) {
  const jarak = hitungJarak(lat, lon, PLN_LAT, PLN_LNG);
  if (jarak <= RADIUS_BATAS) {
    lokasiStatus.innerHTML = `<span class="text-success">‚úÖ Dalam radius (${(jarak*1000).toFixed(1)} m)</span>`;
  } else {
    lokasiStatus.innerHTML = `<span class="text-danger">‚ùå Di luar radius (${(jarak*1000).toFixed(1)} m)</span>`;
  }
}

if (navigator.geolocation) {
  navigator.geolocation.getCurrentPosition(pos => {
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;
    lokasiInput.value = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
    cekRadius(lat, lon);
  }, err => {
    lokasiInput.value = "Gagal deteksi lokasi";
    lokasiStatus.innerHTML = "‚ùå Izin lokasi ditolak";
  });
} else {
  lokasiInput.value = "Perangkat tidak mendukung GPS";
}

// ========== DATA LOCALSTORAGE ==========
const kirimBtn = document.getElementById('kirimAbsensi');
const resetBtn = document.getElementById('resetForm');
const exportBtn = document.getElementById('exportCSV');
const cetakBtn = document.getElementById('cetakDaftar');
const hapusBtn = document.getElementById('hapusData');

kirimBtn.addEventListener('click', () => {
  const nirm = document.getElementById('nirm').value;
  const nama = document.getElementById('nama').value;
  const jurusan = document.getElementById('jurusan').value;
  const lokasi = lokasiInput.value;
  const waktu = new Date().toLocaleString();

  if (!nirm || !nama || !jurusan || !fotoData || !lokasi) {
    alert("‚ö†Ô∏è Lengkapi semua data dan ambil foto terlebih dahulu!");
    return;
  }

  const data = { nirm, nama, jurusan, foto: fotoData, lokasi, waktu };
  let absensi = JSON.parse(localStorage.getItem('absensi') || "[]");
  absensi.push(data);
  localStorage.setItem('absensi', JSON.stringify(absensi));
  alert("‚úÖ Absensi berhasil disimpan!");
});

resetBtn.addEventListener('click', () => location.reload());

exportBtn.addEventListener('click', () => {
  const absensi = JSON.parse(localStorage.getItem('absensi') || "[]");
  if (!absensi.length) return alert("Belum ada data!");
  let csv = "NIRM,Nama,Jurusan,Lokasi,Waktu\n";
  absensi.forEach(d => csv += `"${d.nirm}","${d.nama}","${d.jurusan}","${d.lokasi}","${d.waktu}"\n`);
  const blob = new Blob([csv], { type: 'text/csv' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = "data_absensi.csv";
  a.click();
});

cetakBtn.addEventListener('click', () => {
  const absensi = JSON.parse(localStorage.getItem('absensi') || "[]");
  if (!absensi.length) return alert("Belum ada data!");
  let html = "<h3>Daftar Absensi PKL</h3><table border='1' cellspacing='0' cellpadding='6'><tr><th>NIRM</th><th>Nama</th><th>Jurusan</th><th>Foto</th><th>Lokasi</th><th>Waktu</th></tr>";
  absensi.forEach(d => {
    html += `<tr><td>${d.nirm}</td><td>${d.nama}</td><td>${d.jurusan}</td><td><img src="${d.foto}" width="70"></td><td>${d.lokasi}</td><td>${d.waktu}</td></tr>`;
  });
  html += "</table>";
  const newWin = window.open("");
  newWin.document.write(html);
  newWin.print();
});

hapusBtn.addEventListener('click', () => {
  if (confirm("Yakin ingin hapus semua data absensi?")) {
    localStorage.removeItem('absensi');
    alert("üóë Semua data telah dihapus!");
  }
});
</script>

</body>
</html>
